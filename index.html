<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cultural de Lima</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- ESTRUCTURA GENERAL --- */
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100%; overflow: hidden; }
        
        .main-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* --- BARRA LATERAL (AJUSTABLE) --- */
        .sidebar {
            width: 320px;       /* Ancho inicial */
            min-width: 250px;   /* No puede ser muy angosta */
            max-width: 50vw;    /* No puede ocupar m√°s de la mitad de la pantalla */
            background: #f8f9fa;
            padding: 10px;      /* Menos padding general */
            overflow-y: auto;   /* Scroll vertical */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1001;
            
            /* PROPIEDAD M√ÅGICA PARA REDIMENSIONAR */
            resize: horizontal; 
            overflow-x: hidden; /* Evita scroll horizontal feo */
        }

        /* MAPA */
        #map { flex-grow: 1; height: 100%; background: #e0e0e0; }

        /* --- ESTILOS COMPACTOS --- */
        .titulo-seccion { font-size: 0.95em; margin-bottom: 3px; color: #444; font-weight: bold; margin-top: 5px;}
        
        select.filtro-dia {
            width: 100%; padding: 6px; background: #fff; border: 1px solid #007bff;
            border-radius: 4px; font-size: 13px; color: #333; cursor: pointer; font-weight: bold;
        }

        /* Botones de Filtro m√°s compactos */
        .btn-filtro {
            width: 100%; padding: 6px 10px; cursor: pointer;
            background: #fff; border: 1px solid #ccc; border-radius: 4px; text-align: left; font-size: 13px;
            transition: all 0.2s; margin-bottom: 3px;
        }
        .btn-filtro:hover { background: #f0f0f0; }
        .btn-filtro.activo { background: #007bff; color: white; border-color: #0056b3; }

        /* Contenedor de controles de resultados */
        .controles-resultados {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px;
        }
        
        .btn-ordenar {
            background: #6c757d; color: white; border: none; padding: 4px 8px;
            border-radius: 4px; font-size: 11px; cursor: pointer;
        }
        .btn-ordenar:hover { background: #5a6268; }

        /* --- TARJETAS DE EVENTOS (COMPACTAS) --- */
        .lista-container { margin-top: 5px; }
        
        .evento-card {
            background: white; border: 1px solid #ddd; border-radius: 5px;
            padding: 8px; /* Menos relleno interno */
            margin-bottom: 8px; 
            cursor: pointer;
            transition: border-color 0.2s;
            position: relative;
        }
        .evento-card:hover { border-color: #007bff; border-left: 3px solid #007bff; }
        
        /* Tipograf√≠a peque√±a */
        .evento-card h4 { 
            margin: 0 0 3px 0; 
            font-size: 13px; /* T√≠tulo m√°s peque√±o */
            color: #222; 
            line-height: 1.2;
        }
        .evento-card .meta { 
            font-size: 11px; /* Hora y lugar muy peque√±os */
            color: #007bff; 
            font-weight: 600;
            margin-bottom: 4px; 
        }
        .evento-card .descripcion-completa { 
            font-size: 12px; /* Texto descriptivo compacto */
            color: #555; 
            margin-bottom: 6px; 
            line-height: 1.3;
            text-align: justify;
        }
        
        .btn-agendar {
            padding: 3px 8px; font-size: 11px; border: 1px solid #007bff;
            background: white; color: #007bff; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; float: right;
        }
        .btn-agendar.agendado { background: #007bff; color: white; }

        /* Bot√≥n Final */
        .btn-ruta-final { 
            background: #28a745; color: white; font-weight: bold; font-size: 13px;
            text-align: center; border: none; padding: 10px;
            margin-top: 5px; cursor: pointer; width: 100%; border-radius: 4px;
        }
        .btn-ruta-final:hover { background: #218838; }

        .info-ruta { 
            margin-top: 10px; font-size: 12px; background: #e8f4ff; 
            padding: 8px; border-radius: 4px; border-left: 3px solid #007bff;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <div class="titulo-seccion">üìÖ D√≠a</div>
            <select id="select-dias" class="filtro-dia" onchange="cambiarFiltroDia()">
                <option value="Todos">Cargando d√≠as...</option>
            </select>

            <div class="titulo-seccion">üé≠ Categor√≠a</div>
            <div id="botones-categorias">
                <button class="btn-filtro activo" onclick="cambiarFiltroCategoria('Todos', this)">üëÅÔ∏è Ver Todo</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Teatro', this)">üé≠ Teatro</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('M√∫sica', this)">üéµ M√∫sica</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Cine', this)">üé¨ Cine</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Arte/Expo', this)">üñºÔ∏è Arte / Expo</button>
            </div>
            
            <hr style="width: 100%; border-color: #eee; margin: 8px 0;">

            <div class="controles-resultados">
                <div class="titulo-seccion" style="margin:0">Eventos (<span id="contador-eventos">0</span>)</div>
                <button class="btn-ordenar" onclick="ordenarResultadosPorHora()">üïí Ordenar por Hora</button>
            </div>

            <div id="lista-lateral" class="lista-container">
                <p style="font-size:12px; color:#666">Cargando datos...</p>
            </div>

            <hr style="width: 100%; border-color: #eee; margin: 8px 0;">
            <button class="btn-ruta-final" onclick="crearRutaConSeleccionados()">üöÄ Crear Ruta</button>
            <div id="lista-ruta-resultado" class="info-ruta" style="display: none;"></div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        try {
            // 1. CONFIGURACI√ìN FIREBASE (TUS DATOS)
            const firebaseConfig = {
                apiKey: "AIzaSyCxwRwF97SheBpKd0bfZ6Gcw8XQH2QwNbc",
                authDomain: "mapacultural-lima.firebaseapp.com",
                projectId: "mapacultural-lima",
                storageBucket: "mapacultural-lima.firebasestorage.app",
                messagingSenderId: "170254428690",
                appId: "1:170254428690:web:0b7dbd02636b6af29446cb"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // 2. INICIAR MAPA
            const map = L.map('map').setView([-12.046, -77.042], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // VARIABLES
            let todosLosEventos = [];
            let eventosActuales = []; // Lista filtrada actual
            let seleccionadosIDs = new Set();
            let marcadores = {}; 
            let lineaRuta = null;
            let filtroDiaActual = 'Todos';
            let filtroCategoriaActual = 'Todos';

            // 3. DESCARGA
            console.log("Descargando...");
            db.collection("eventos").get().then((snapshot) => {
                if (snapshot.empty) {
                    document.getElementById('lista-lateral').innerHTML = "<p>Base de datos vac√≠a.</p>";
                    return;
                }
                snapshot.forEach((doc) => {
                    let data = doc.data();
                    data.id = doc.id;
                    todosLosEventos.push(data);
                });
                
                // Inicializar
                llenarDropdownDias();
                aplicarFiltrosCombinados();

            }).catch((error) => {
                console.error(error);
                alert("Error de conexi√≥n: " + error.message);
            });

            // --- FUNCIONES ---

            function llenarDropdownDias() {
                const select = document.getElementById('select-dias');
                const diasUnicos = new Set();
                todosLosEventos.forEach(ev => { if(ev.dia) diasUnicos.add(ev.dia); });
                const listaDias = Array.from(diasUnicos).sort();
                
                select.innerHTML = '<option value="Todos">üìÖ Todos los D√≠as</option>';
                listaDias.forEach(dia => {
                    let option = document.createElement("option");
                    option.value = dia;
                    option.text = dia;
                    select.appendChild(option);
                });
            }

            function cambiarFiltroDia() {
                filtroDiaActual = document.getElementById('select-dias').value;
                aplicarFiltrosCombinados();
            }

            function cambiarFiltroCategoria(categoria, botonPresionado) {
                filtroCategoriaActual = categoria;
                const botones = document.querySelectorAll('#botones-categorias .btn-filtro');
                botones.forEach(btn => btn.classList.remove('activo'));
                botonPresionado.classList.add('activo');
                aplicarFiltrosCombinados();
            }

            function aplicarFiltrosCombinados() {
                eventosActuales = todosLosEventos.filter(ev => {
                    const coincideDia = (filtroDiaActual === 'Todos') || (ev.dia === filtroDiaActual);
                    const coincideCat = (filtroCategoriaActual === 'Todos') || (ev.tipo === filtroCategoriaActual);
                    return coincideDia && coincideCat;
                });
                actualizarVista(eventosActuales);
            }

            // NUEVA FUNCI√ìN: ORDENAR POR HORA
            function ordenarResultadosPorHora() {
                eventosActuales.sort((a, b) => a.hora.localeCompare(b.hora));
                actualizarVista(eventosActuales);
            }

            function actualizarVista(lista) {
                // Limpiar
                for (let id in marcadores) map.removeLayer(marcadores[id]);
                marcadores = {};
                if(lineaRuta) map.removeLayer(lineaRuta);
                document.getElementById('lista-ruta-resultado').style.display = 'none';

                let htmlLista = "";
                document.getElementById('contador-eventos').innerText = lista.length;

                if (lista.length === 0) {
                    htmlLista = "<p style='text-align:center; padding:10px; color:#777; font-size:12px;'>Sin resultados.</p>";
                }

                lista.forEach(ev => {
                    let lat = parseFloat(ev.lat);
                    let lon = parseFloat(ev.lon);
                    if(isNaN(lat) || isNaN(lon)) return;

                    // Marcador
                    let marker = L.marker([lat, lon])
                        .bindPopup(`<b>${ev.hora}</b><br>${ev.nombre}<br><i>${ev.lugar}</i>`);
                    marker.addTo(map);
                    marcadores[ev.id] = marker;

                    // Tarjeta
                    const estaAgendado = seleccionadosIDs.has(ev.id);
                    const claseBoton = estaAgendado ? 'btn-agendar agendado' : 'btn-agendar';
                    const textoBoton = estaAgendado ? '‚úÖ' : 'Agendar';
                    
                    // L√ìGICA DE TEXTO: Usamos nombre_completo si existe, sino nombre
                    const textoPrincipal = ev.nombre_completo ? ev.nombre_completo : ev.nombre;

                    htmlLista += `
                        <div class="evento-card" onclick="resaltarEnMapa('${ev.id}')">
                            <button id="btn-${ev.id}" class="${claseBoton}" onclick="event.stopPropagation(); toggleAgendar('${ev.id}')">
                                ${textoBoton}
                            </button>
                            <div class="meta">üïí ${ev.hora} | üìç ${ev.lugar}</div>
                            <div class="descripcion-completa">${textoPrincipal}</div>
                        </div>
                    `;
                });

                document.getElementById('lista-lateral').innerHTML = htmlLista;
            }

            function resaltarEnMapa(id) {
                const marker = marcadores[id];
                if (marker) {
                    map.flyTo(marker.getLatLng(), 16, { duration: 1.5 });
                    marker.openPopup();
                }
            }

            window.toggleAgendar = function(id) {
                const btn = document.getElementById(`btn-${id}`);
                if (seleccionadosIDs.has(id)) {
                    seleccionadosIDs.delete(id);
                    btn.classList.remove('agendado');
                    btn.innerHTML = 'Agendar';
                } else {
                    seleccionadosIDs.add(id);
                    btn.classList.add('agendado');
                    btn.innerHTML = '‚úÖ';
                }
                document.getElementById('lista-ruta-resultado').style.display = 'none';
                if(lineaRuta) map.removeLayer(lineaRuta);
            }

            window.crearRutaConSeleccionados = function() {
                let rutaEventos = todosLosEventos.filter(ev => seleccionadosIDs.has(ev.id));
                if (rutaEventos.length < 2) {
                    alert("Selecciona al menos 2 eventos.");
                    return;
                }
                rutaEventos.sort((a, b) => a.hora.localeCompare(b.hora));
                
                let latlngs = rutaEventos.map(e => [parseFloat(e.lat), parseFloat(e.lon)]);
                if(lineaRuta) map.removeLayer(lineaRuta);
                lineaRuta = L.polyline(latlngs, {color: '#007bff', weight: 5, opacity: 0.8}).addTo(map);
                map.fitBounds(lineaRuta.getBounds(), {padding: [50, 50]});

                let html = "<b>üóìÔ∏è Ruta Sugerida:</b><br>";
                rutaEventos.forEach((e, i) => {
                    html += `<div style="margin-bottom:5px; border-bottom:1px dotted #ccc; padding-bottom:3px;">
                                <b>${i+1}. [${e.hora}]</b> ${e.nombre.substring(0,30)}...<br>
                                <small>üìç ${e.lugar}</small>
                             </div>`;
                });
                const resDiv = document.getElementById('lista-ruta-resultado');
                resDiv.innerHTML = html;
                resDiv.style.display = 'block';
                resDiv.scrollIntoView({ behavior: 'smooth' });
            }

        } catch (error) {
            alert("Error cr√≠tico: " + error.message);
        }
    </script>
</body>
</html>
