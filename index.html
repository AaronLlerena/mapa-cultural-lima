<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cultural de Lima</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100%; overflow: hidden; }
        .main-container { display: flex; height: 100vh; width: 100%; }

        /* BARRA LATERAL */
        .sidebar {
            width: 340px; min-width: 280px; max-width: 50vw;
            background: #f8f9fa; padding: 10px; overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; z-index: 1001;
            resize: horizontal; overflow-x: hidden;
        }

        #map { flex-grow: 1; height: 100%; background: #e0e0e0; }

        .titulo-seccion { font-size: 0.9em; margin-bottom: 3px; color: #555; font-weight: bold; margin-top: 8px; text-transform: uppercase; letter-spacing: 0.5px;}
        
        select.filtro-dia {
            width: 100%; padding: 8px; background: #fff; border: 1px solid #007bff;
            border-radius: 6px; font-size: 14px; color: #333; cursor: pointer; font-weight: bold;
        }

        .btn-filtro {
            width: 100%; padding: 8px 10px; cursor: pointer;
            background: #fff; border: 1px solid #ddd; border-radius: 6px; text-align: left; font-size: 13px;
            transition: all 0.2s; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;
        }
        .btn-filtro:hover { background: #f1f3f5; transform: translateX(2px); }
        .btn-filtro.activo { background: #007bff; color: white; border-color: #0056b3; box-shadow: 0 2px 4px rgba(0,123,255,0.3); }

        .controles-resultados { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .btn-ordenar { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; }

        /* TARJETAS MEJORADAS */
        .lista-container { margin-top: 5px; }
        .evento-card {
            background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; 
            margin-bottom: 10px; cursor: pointer; transition: all 0.2s; position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .evento-card:hover { border-color: #007bff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .evento-card h4 { margin: 0 0 5px 0; font-size: 14px; color: #222; line-height: 1.3; }
        
        /* Nueva secci√≥n de META DATOS (Lugar y Direcci√≥n) */
        .evento-card .meta-lugar { 
            font-size: 12px; color: #007bff; font-weight: 700; margin-bottom: 2px; 
        }
        .evento-card .meta-direccion { 
            font-size: 11px; color: #666; font-style: italic; margin-bottom: 8px; display: block;
        }
        .evento-card .meta-hora {
            display: inline-block; background: #e9ecef; padding: 2px 6px; border-radius: 4px; 
            font-size: 11px; color: #333; font-weight: bold; margin-bottom: 6px;
        }

        .evento-card .descripcion-completa { font-size: 12px; color: #444; margin-bottom: 5px; line-height: 1.4; text-align: left; }
        
        .btn-agendar {
            position: absolute; top: 10px; right: 10px;
            padding: 4px 10px; font-size: 11px; border: 1px solid #007bff;
            background: white; color: #007bff; border-radius: 20px;
            cursor: pointer; transition: all 0.2s; font-weight: 600;
        }
        .btn-agendar:hover { background: #f0f8ff; }
        .btn-agendar.agendado { background: #007bff; color: white; border-color: #0056b3; }

        .btn-ruta-final { 
            background: #28a745; color: white; font-weight: bold; font-size: 14px;
            text-align: center; border: none; padding: 12px; margin-top: 5px; cursor: pointer; width: 100%; border-radius: 6px;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3); transition: background 0.2s;
        }
        .btn-ruta-final:hover { background: #218838; }

        .info-ruta { margin-top: 15px; font-size: 12px; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; }

        /* ICONOS MAPA */
        .icono-numero {
            background-color: #007bff; color: white; border-radius: 50%; text-align: center;
            line-height: 24px; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .icono-numero.inicio { background-color: #28a745; width: 30px !important; height: 30px !important; line-height: 26px; font-size: 14px; z-index: 1000 !important; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <div class="titulo-seccion">üìÖ ¬øCu√°ndo quieres salir?</div>
            <select id="select-dias" class="filtro-dia" onchange="cambiarFiltroDia()">
                <option value="Todos">Cargando d√≠as...</option>
            </select>

            <div class="titulo-seccion">üé≠ ¬øQu√© te provoca?</div>
            <div id="botones-categorias">
                <button class="btn-filtro activo" onclick="cambiarFiltroCategoria('Todos', this)">üëÅÔ∏è Ver Todo</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Teatro', this)">üé≠ Teatro</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('M√∫sica', this)">üéµ M√∫sica</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Cine', this)">üé¨ Cine</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Arte/Expo', this)">üñºÔ∏è Arte / Expo</button>
            </div>
            
            <hr style="width: 100%; border-color: #eee; margin: 10px 0;">

            <div class="controles-resultados">
                <div class="titulo-seccion" style="margin:0">Eventos (<span id="contador-eventos">0</span>)</div>
                <button class="btn-ordenar" onclick="ordenarResultadosPorHora()">üïí Ordenar por Hora</button>
            </div>

            <div id="lista-lateral" class="lista-container">
                <p style="font-size:12px; color:#666; text-align:center;">Cargando datos culturales...</p>
            </div>

            <hr style="width: 100%; border-color: #eee; margin: 10px 0;">
            <button class="btn-ruta-final" onclick="crearRutaConSeleccionados()">üöÄ Crear Ruta</button>
            <div id="lista-ruta-resultado" class="info-ruta" style="display: none;"></div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polyline-decorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        try {
            // CLAVES DE FIREBASE (NO CAMBIAR)
            const firebaseConfig = {
                apiKey: "AIzaSyCxwRwF97SheBpKd0bfZ6Gcw8XQH2QwNbc",
                authDomain: "mapacultural-lima.firebaseapp.com",
                projectId: "mapacultural-lima",
                storageBucket: "mapacultural-lima.firebasestorage.app",
                messagingSenderId: "170254428690",
                appId: "1:170254428690:web:0b7dbd02636b6af29446cb"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // MAPA
            const map = L.map('map').setView([-12.046, -77.042], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

            // DATOS
            let todosLosEventos = [];
            let eventosActuales = []; 
            let seleccionadosIDs = new Set();
            let marcadores = {}; 
            let lineaRuta = null;
            let flechasRuta = null;
            let marcadoresRuta = []; 
            let filtroDiaActual = 'Todos';
            let filtroCategoriaActual = 'Todos';

            console.log("Descargando eventos...");
            db.collection("eventos").get().then((snapshot) => {
                if (snapshot.empty) {
                    document.getElementById('lista-lateral').innerHTML = "<p>Base de datos vac√≠a. Corre el scraper de Python.</p>";
                    return;
                }
                snapshot.forEach((doc) => {
                    let data = doc.data();
                    data.id = doc.id;
                    todosLosEventos.push(data);
                });
                llenarDropdownDias();
                aplicarFiltrosCombinados();
            }).catch(e => alert("Error DB: " + e.message));

            // FUNCIONES UI
            function llenarDropdownDias() {
                const select = document.getElementById('select-dias');
                const diasUnicos = new Set();
                todosLosEventos.forEach(ev => { if(ev.dia) diasUnicos.add(ev.dia); });
                const listaDias = Array.from(diasUnicos).sort();
                select.innerHTML = '<option value="Todos">üìÖ Todos los D√≠as</option>';
                listaDias.forEach(dia => {
                    let opt = document.createElement("option"); opt.value = dia; opt.text = dia; select.appendChild(opt);
                });
            }

            function cambiarFiltroDia() {
                filtroDiaActual = document.getElementById('select-dias').value;
                aplicarFiltrosCombinados();
            }

            function cambiarFiltroCategoria(categoria, boton) {
                filtroCategoriaActual = categoria;
                document.querySelectorAll('#botones-categorias .btn-filtro').forEach(b => b.classList.remove('activo'));
                boton.classList.add('activo');
                aplicarFiltrosCombinados();
            }

            function aplicarFiltrosCombinados() {
                eventosActuales = todosLosEventos.filter(ev => {
                    const diaOk = (filtroDiaActual === 'Todos') || (ev.dia === filtroDiaActual);
                    const catOk = (filtroCategoriaActual === 'Todos') || (ev.tipo === filtroCategoriaActual);
                    return diaOk && catOk;
                });
                actualizarVista(eventosActuales);
            }

            function ordenarResultadosPorHora() {
                eventosActuales.sort((a, b) => a.hora.localeCompare(b.hora));
                actualizarVista(eventosActuales);
            }

            function limpiarRutaEnMapa() {
                if(lineaRuta) map.removeLayer(lineaRuta);
                if(flechasRuta) map.removeLayer(flechasRuta);
                marcadoresRuta.forEach(m => map.removeLayer(m));
                marcadoresRuta = [];
                // Restaurar pines azules si no hay ruta activa
                if(seleccionadosIDs.size < 2) {
                     for (let id in marcadores) { if(!map.hasLayer(marcadores[id])) marcadores[id].addTo(map); }
                }
            }

            function actualizarVista(lista) {
                limpiarRutaEnMapa();
                for (let id in marcadores) map.removeLayer(marcadores[id]);
                marcadores = {};

                let html = "";
                document.getElementById('contador-eventos').innerText = lista.length;

                if (lista.length === 0) html = "<p style='text-align:center; padding:10px; color:#777;'>Sin resultados.</p>";

                lista.forEach(ev => {
                    let lat = parseFloat(ev.lat);
                    let lon = parseFloat(ev.lon);
                    if(isNaN(lat)) return;

                    let marker = L.marker([lat, lon]).bindPopup(`<b>${ev.hora}</b><br>${ev.nombre}`);
                    marker.addTo(map);
                    marcadores[ev.id] = marker;

                    const agendado = seleccionadosIDs.has(ev.id);
                    const btnClass = agendado ? 'btn-agendar agendado' : 'btn-agendar';
                    const btnText = agendado ? '‚úÖ Agendado' : 'Agendar';
                    
                    // L√≥gica para mostrar direcci√≥n si existe
                    const direccionMostrar = ev.direccion ? ev.direccion : ev.lugar;
                    const nombreCompleto = ev.nombre_completo || ev.nombre;

                    html += `
                        <div class="evento-card" onclick="resaltarEnMapa('${ev.id}')">
                            <button id="btn-${ev.id}" class="${btnClass}" onclick="event.stopPropagation(); toggleAgendar('${ev.id}')">${btnText}</button>
                            <h4>${ev.nombre}</h4>
                            <span class="meta-hora">üïí ${ev.hora}</span>
                            <div class="meta-lugar">üìç ${ev.lugar}</div>
                            <span class="meta-direccion">${direccionMostrar}</span>
                            <div class="descripcion-completa">${nombreCompleto}</div>
                        </div>`;
                });
                document.getElementById('lista-lateral').innerHTML = html;
            }

            function resaltarEnMapa(id) {
                const marker = marcadores[id];
                if (marker) {
                    map.flyTo(marker.getLatLng(), 16, { duration: 1.5 });
                    marker.openPopup();
                }
            }

            window.toggleAgendar = function(id) {
                const btn = document.getElementById(`btn-${id}`);
                if (seleccionadosIDs.has(id)) {
                    seleccionadosIDs.delete(id);
                    btn.classList.remove('agendado');
                    btn.innerHTML = 'Agendar';
                } else {
                    seleccionadosIDs.add(id);
                    btn.classList.add('agendado');
                    btn.innerHTML = '‚úÖ Agendado';
                }
                document.getElementById('lista-ruta-resultado').style.display = 'none';
                limpiarRutaEnMapa();
            }

            window.crearRutaConSeleccionados = function() {
                let ruta = todosLosEventos.filter(ev => seleccionadosIDs.has(ev.id));
                if (ruta.length < 2) { alert("Selecciona al menos 2 eventos."); return; }
                
                ruta.sort((a, b) => a.hora.localeCompare(b.hora));
                limpiarRutaEnMapa();
                for (let id in marcadores) map.removeLayer(marcadores[id]); // Ocultar pines azules

                let latlngs = [];
                ruta.forEach((ev, i) => {
                    let lat = parseFloat(ev.lat), lon = parseFloat(ev.lon);
                    latlngs.push([lat, lon]);
                    let cls = i === 0 ? 'inicio' : '';
                    let icon = L.divIcon({className: 'custom', html: `<div class='icono-numero ${cls}'>${i+1}</div>`, iconSize:[25,25], iconAnchor:[12,12]});
                    let m = L.marker([lat, lon], {icon: icon}).bindPopup(`<b>${i+1}. ${ev.hora}</b><br>${ev.nombre}`).addTo(map);
                    marcadoresRuta.push(m);
                });

                // L√çNEA DE RUTA
                lineaRuta = L.polyline(latlngs, {color: '#007bff', weight: 4, opacity: 0.8, dashArray: '10, 10'}).addTo(map);

                // FLECHAS MEJORADAS (Visible antes de llegar al punto)
                flechasRuta = L.polylineDecorator(lineaRuta, {
                    patterns: [
                        {
                            offset: '10%', // Empieza un poco despu√©s del inicio
                            repeat: 0, // No repetir autom√°ticamente en base a distancia
                            endOffset: '25px', // ¬°CLAVE! Termina 25px antes del punto final para que se vea la punta
                            symbol: L.Symbol.arrowHead({
                                pixelSize: 15, // Flecha m√°s grande
                                polygon: false, 
                                pathOptions: { stroke: true, color: '#007bff', weight: 3 }
                            })
                        },
                        {
                            // Una segunda flecha en medio del camino si es largo
                            offset: '50%',
                            repeat: '300px',
                            symbol: L.Symbol.arrowHead({ pixelSize: 12, polygon: false, pathOptions: { stroke: true, color: '#007bff', weight: 2 } })
                        }
                    ]
                }).addTo(map);

                map.fitBounds(lineaRuta.getBounds(), {padding: [50,50]});

                // MOSTRAR ITINERARIO
                let html = "<b>üóìÔ∏è Tu Ruta Cultural:</b><br>";
                ruta.forEach((e, i) => {
                    html += `<div style="margin-bottom:8px; border-bottom:1px dotted #ccc; padding-bottom:5px;">
                        <span style="background:${i===0?'#28a745':'#007bff'}; color:white; border-radius:50%; padding:2px 7px; font-size:11px; font-weight:bold;">${i+1}</span>
                        <b>${e.hora}</b> - ${e.nombre.substring(0,30)}...<br>
                        <small style="color:#666; margin-left:25px; display:block;">üìç ${e.lugar}</small>
                    </div>`;
                });
                const r = document.getElementById('lista-ruta-resultado');
                r.innerHTML = html; r.style.display = 'block'; r.scrollIntoView({behavior:'smooth'});
            }
        } catch (e) { alert("Error cr√≠tico: " + e.message); }
    </script>
</body>
</html>
