<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cultural de Lima</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- ESTRUCTURA PRINCIPAL --- */
        body, html { margin: 0; padding: 0; font-family: sans-serif; height: 100%; }
        
        .main-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* --- BARRA LATERAL --- */
        .sidebar {
            width: 350px;
            min-width: 300px;
            background: #f8f9fa;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #map { flex-grow: 1; height: 100%; }

        /* Estilos de Botones y Selects */
        .titulo-seccion { font-size: 1.1em; margin-bottom: 5px; color: #333; font-weight: bold; }

        .btn-filtro {
            width: 100%; padding: 10px; cursor: pointer;
            background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; text-align: left; font-size: 14px;
            transition: background 0.2s;
            margin-bottom: 5px;
        }
        .btn-filtro:hover { background: #dee2e6; }
        
        /* Estilo para el bot√≥n activo */
        .btn-filtro.activo {
            background: #007bff; color: white; border-color: #0056b3;
        }

        /* NUEVO: Estilo del Men√∫ Desplegable de D√≠as */
        select.filtro-dia {
            width: 100%; padding: 10px;
            background: #fff; border: 2px solid #007bff; border-radius: 4px;
            font-size: 15px; color: #333; cursor: pointer;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .btn-ruta-final { 
            background: #28a745; color: white; font-weight: bold; 
            text-align: center; border: none; padding: 12px;
            margin-top: 10px; cursor: pointer; width: 100%; border-radius: 4px;
        }
        .btn-ruta-final:hover { background: #218838; }

        /* --- TARJETAS DE EVENTOS --- */
        .lista-container { margin-top: 10px; }
        
        .evento-card {
            background: white; border: 1px solid #ddd; border-radius: 6px;
            padding: 12px; margin-bottom: 10px; cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .evento-card:hover { border-color: #007bff; box-shadow: 0 2px 8px rgba(0,123,255,0.2); }
        .evento-card h4 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
        .evento-card .meta { font-size: 0.85em; color: #666; margin-bottom: 8px; }
        .evento-card .descripcion-completa { font-size: 0.9em; color: #444; margin-bottom: 10px; line-height: 1.4; }
        
        .btn-agendar {
            padding: 6px 12px; font-size: 0.85em; border: 1px solid #007bff;
            background: white; color: #007bff; border-radius: 20px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-agendar.agendado { background: #007bff; color: white; }

        .info-ruta { 
            margin-top: 15px; font-size: 0.9em; 
            background: #e8f4ff; padding: 10px; border-radius: 5px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            
            <div class="titulo-seccion">üìÖ ¬øCu√°ndo quieres salir?</div>
            <select id="select-dias" class="filtro-dia" onchange="cambiarFiltroDia()">
                <option value="Todos">Ver Todos los D√≠as</option>
                </select>

            <hr style="width: 100%; border-color: #ddd;">

            <div class="titulo-seccion">üé≠ ¬øQu√© quieres ver?</div>
            <div id="botones-categorias">
                <button class="btn-filtro activo" onclick="cambiarFiltroCategoria('Todos', this)">üëÅÔ∏è Ver Todo</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Teatro', this)">üé≠ Teatro</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('M√∫sica', this)">üéµ M√∫sica</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Cine', this)">üé¨ Cine</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Arte/Expo', this)">üñºÔ∏è Arte / Expo</button>
            </div>
            
            <hr style="width: 100%; border-color: #ddd;">

            <div class="titulo-seccion">Resultados: <span id="contador-eventos">0</span></div>
            <div id="lista-lateral" class="lista-container">
                <p style="color:#666">Cargando...</p>
            </div>

            <hr style="width: 100%; border-color: #ddd;">
            
            <button class="btn-ruta-final" onclick="crearRutaConSeleccionados()">üöÄ Crear Ruta con Mis Eventos</button>
            <div id="lista-ruta-resultado" class="info-ruta" style="display: none;"></div>
        </div>

        <div id="map"></div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCxwRwF97SheBpKd0bfZ6Gcw8XQH2QwNbc",
            authDomain: "mapacultural-lima.firebaseapp.com",
            projectId: "mapacultural-lima",
            storageBucket: "mapacultural-lima.firebasestorage.app",
            messagingSenderId: "170254428690",
            appId: "1:170254428690:web:0b7dbd02636b6af29446cb"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // INICIAR MAPA
        const map = L.map('map').setView([-12.046, -77.042], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // VARIABLES GLOBALES
        let todosLosEventos = [];
        let seleccionadosIDs = new Set();
        let marcadores = {}; 
        let lineaRuta = null;

        // ESTADO DE LOS FILTROS
        let filtroDiaActual = 'Todos';
        let filtroCategoriaActual = 'Todos';

        // 1. DESCARGAR EVENTOS
        db.collection("eventos").get().then((snapshot) => {
            snapshot.forEach((doc) => {
                let data = doc.data();
                data.id = doc.id;
                todosLosEventos.push(data);
            });
            
            // Una vez descargados, configuramos la vista inicial
            llenarDropdownDias(); // <--- NUEVO: Detecta los d√≠as autom√°ticamente
            aplicarFiltrosCombinados();
        });

        // --- NUEVA FUNCI√ìN: Llenar el men√∫ de d√≠as autom√°ticamente ---
        function llenarDropdownDias() {
            const select = document.getElementById('select-dias');
            // Usamos un Set para obtener d√≠as √∫nicos (evitar repetidos)
            const diasUnicos = new Set();
            
            todosLosEventos.forEach(ev => {
                if(ev.dia) diasUnicos.add(ev.dia);
            });

            // Ordenamos los d√≠as (alfab√©ticamente sirve para Lunes, Martes...)
            const listaDias = Array.from(diasUnicos).sort();

            // Creamos las opciones en el HTML
            listaDias.forEach(dia => {
                let option = document.createElement("option");
                option.value = dia;
                option.text = "üìÖ " + dia;
                select.appendChild(option);
            });
        }

        // --- GESTI√ìN DE FILTROS ---
        
        // Cuando cambias el Select de D√≠a
        function cambiarFiltroDia() {
            filtroDiaActual = document.getElementById('select-dias').value;
            aplicarFiltrosCombinados();
        }

        // Cuando haces click en un bot√≥n de Categor√≠a
        function cambiarFiltroCategoria(categoria, botonPresionado) {
            filtroCategoriaActual = categoria;
            
            // Actualizar estilo visual de los botones (quitar activo a todos, poner al presionado)
            const botones = document.querySelectorAll('#botones-categorias .btn-filtro');
            botones.forEach(btn => btn.classList.remove('activo'));
            botonPresionado.classList.add('activo');

            aplicarFiltrosCombinados();
        }

        // EL CEREBRO DE LOS FILTROS: Combina D√≠a + Categor√≠a
        function aplicarFiltrosCombinados() {
            const eventosFiltrados = todosLosEventos.filter(ev => {
                // Condici√≥n 1: Coincide el d√≠a? (o est√° en 'Todos')
                const coincideDia = (filtroDiaActual === 'Todos') || (ev.dia === filtroDiaActual);
                
                // Condici√≥n 2: Coincide la categor√≠a? (o est√° en 'Todos')
                const coincideCat = (filtroCategoriaActual === 'Todos') || (ev.tipo === filtroCategoriaActual);

                // Deben cumplirse AMBAS
                return coincideDia && coincideCat;
            });

            actualizarVista(eventosFiltrados);
        }

        // --- ACTUALIZAR MAPA Y LISTA ---
        function actualizarVista(listaDeEventos) {
            // Limpiar todo
            for (let id in marcadores) map.removeLayer(marcadores[id]);
            marcadores = {};
            if(lineaRuta) map.removeLayer(lineaRuta);
            document.getElementById('lista-ruta-resultado').style.display = 'none';

            let htmlLista = "";
            document.getElementById('contador-eventos').innerText = listaDeEventos.length;

            if (listaDeEventos.length === 0) {
                htmlLista = "<p style='text-align:center; padding:20px;'>No hay eventos con estos filtros üò¢</p>";
            }

            listaDeEventos.forEach(ev => {
                let lat = parseFloat(ev.lat);
                let lon = parseFloat(ev.lon);
                if(isNaN(lat) || isNaN(lon)) return;

                // Marcador
                let marker = L.marker([lat, lon])
                    .bindPopup(`<b>${ev.hora}</b><br>${ev.nombre}<br><i>${ev.lugar}</i>`);
                marker.addTo(map);
                marcadores[ev.id] = marker;

                // Tarjeta HTML
                const estaAgendado = seleccionadosIDs.has(ev.id);
                const claseBoton = estaAgendado ? 'btn-agendar agendado' : 'btn-agendar';
                const textoBoton = estaAgendado ? '‚úÖ Agendado' : 'Agendar';

                htmlLista += `
                    <div class="evento-card" onclick="resaltarEnMapa('${ev.id}')">
                        <h4>${ev.nombre}</h4>
                        <div class="meta">üïí ${ev.hora} | ${ev.dia || ''} <br> üìç ${ev.lugar}</div>
                        <div class="descripcion-completa">${ev.nombre_completo}</div>
                        <button id="btn-${ev.id}" class="${claseBoton}" onclick="event.stopPropagation(); toggleAgendar('${ev.id}')">
                            ${textoBoton}
                        </button>
                    </div>
                `;
            });

            document.getElementById('lista-lateral').innerHTML = htmlLista;
        }

        // --- INTERACCIONES Y RUTA (Igual que antes) ---

        function resaltarEnMapa(id) {
            const marker = marcadores[id];
            if (marker) {
                map.flyTo(marker.getLatLng(), 16, { duration: 1.5 });
                marker.openPopup();
            }
        }

        function toggleAgendar(id) {
            const btn = document.getElementById(`btn-${id}`);
            if (seleccionadosIDs.has(id)) {
                seleccionadosIDs.delete(id);
                btn.classList.remove('agendado');
                btn.innerHTML = 'Agendar';
            } else {
                seleccionadosIDs.add(id);
                btn.classList.add('agendado');
                btn.innerHTML = '‚úÖ Agendado';
            }
            document.getElementById('lista-ruta-resultado').style.display = 'none';
            if(lineaRuta) map.removeLayer(lineaRuta);
        }

        function crearRutaConSeleccionados() {
            let rutaEventos = todosLosEventos.filter(ev => seleccionadosIDs.has(ev.id));

            if (rutaEventos.length < 2) {
                alert("Agenda al menos 2 eventos para crear una ruta.");
                return;
            }

            // Ordenar por hora
            rutaEventos.sort((a, b) => a.hora.localeCompare(b.hora));
            
            // Dibujar l√≠nea
            let latlngs = rutaEventos.map(e =>
