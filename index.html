<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cultural de Lima</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Estilos para que el mapa ocupe toda la pantalla */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Estilo del Men√∫ Flotante */
        .panel {
            position: absolute; 
            top: 10px; 
            right: 10px; 
            z-index: 1000; /* Asegura que flote sobre el mapa */
            background: white; 
            padding: 15px; 
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
            width: 250px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        button {
            width: 100%; 
            padding: 10px; 
            margin-bottom: 5px; 
            cursor: pointer;
            background: #f0f0f0; 
            border: none; 
            border-radius: 4px; 
            text-align: left;
            font-size: 14px;
        }
        
        button:hover { background: #e0e0e0; }
        
        .btn-ruta { 
            background: #4CAF50; 
            color: white; 
            font-weight: bold; 
            margin-top: 10px; 
            text-align: center;
        }
        
        .info-ruta { 
            margin-top: 15px; 
            font-size: 0.9em; 
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
    </style>
</head>
<body>

    <div class="panel">
        <h3>üé≠ Filtros</h3>
        <button onclick="filtrar('Todos')">üëÅÔ∏è Ver Todo</button>
        <button onclick="filtrar('Teatro')">üé≠ Teatro</button>
        <button onclick="filtrar('M√∫sica')">üéµ M√∫sica</button>
        <button onclick="filtrar('Arte')">üñºÔ∏è Arte / Expo</button>
        <hr>
        <button class="btn-ruta" onclick="crearRuta()">üöÄ Crear Ruta por Hora</button>
        <div id="lista-ruta" class="info-ruta"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // ==========================================
        // --- ZONA DE PEGAR TUS CLAVES AQUI ---
        // ==========================================
        // Borra los textos de ejemplo y pon tus claves reales
        // que obtuviste en la configuraci√≥n de Firebase.
        
        const firebaseConfig = {
            apiKey: "PEGA_TU_API_KEY_AQUI",
            authDomain: "PEGA_TU_AUTHDOMAIN_AQUI",
            projectId: "PEGA_TU_PROJECTID_AQUI",
            storageBucket: "PEGA_TU_STORAGEBUCKET_AQUI",
            messagingSenderId: "PEGA_TU_SENDERID_AQUI",
            appId: "PEGA_TU_APPID_AQUI"
        };

        // ==========================================
        // NO TOQUES NADA DEBAJO DE ESTA LINEA
        // ==========================================

        // 1. Iniciar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase conectado correctamente");
        } catch (error) {
            console.error("Error conectando Firebase:", error);
            alert("Error en la configuraci√≥n de Firebase. Revisa la consola.");
        }
        
        const db = firebase.firestore();

        // 2. Iniciar Mapa (Centrado en Lima)
        const map = L.map('map').setView([-12.046, -77.042], 12); 
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Variables globales
        let eventos = [];
        let marcadores = [];
        let lineaRuta = null;

        // 3. Funci√≥n para descargar datos de Firebase
        console.log("Intentando descargar eventos...");
        db.collection("eventos").get().then((snapshot) => {
            if (snapshot.empty) {
                console.log("No se encontraron eventos en la base de datos.");
            }
            snapshot.forEach((doc) => {
                const data = doc.data();
                console.log("Evento encontrado:", data.nombre);
                eventos.push(data);
            });
            // Una vez descargados, los mostramos
            mostrarMapa(eventos);
        }).catch((error) => {
            console.error("Error leyendo documentos: ", error);
        });

        // 4. Funci√≥n para pintar los puntos
        function mostrarMapa(lista) {
            // Limpiar marcadores viejos
            marcadores.forEach(m => map.removeLayer(m));
            if(lineaRuta) map.removeLayer(lineaRuta);
            marcadores = [];
            document.getElementById('lista-ruta').innerHTML = "";

            lista.forEach(ev => {
                // Asegurarse de que lat/lon sean n√∫meros
                const lat = parseFloat(ev.lat);
                const lon = parseFloat(ev.lon);

                if (!isNaN(lat) && !isNaN(lon)) {
                    let marker = L.marker([lat, lon])
                        .bindPopup(`
                            <div style="text-align:center">
                                <b>${ev.nombre}</b><br>
                                <span style="background:#eee; padding:2px 5px; border-radius:3px">${ev.tipo}</span><br>
                                üïí ${ev.hora}<br>
                                üìç
