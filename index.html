<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cultural de Lima</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- NUEVA ESTRUCTURA PRINCIPAL --- */
        body, html { margin: 0; padding: 0; font-family: sans-serif; height: 100%; }
        
        /* Contenedor flexible: Barra lateral a la izquierda, Mapa a la derecha */
        .main-container {
            display: flex;
            height: 100vh; /* Altura completa de la ventana */
            width: 100%;
        }

        /* --- BARRA LATERAL IZQUIERDA --- */
        .sidebar {
            width: 350px; /* Ancho fijo */
            min-width: 300px;
            background: #f8f9fa;
            padding: 15px;
            overflow-y: auto; /* Barra de desplazamiento si es muy larga */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- EL MAPA --- */
        #map {
            flex-grow: 1; /* Ocupa todo el espacio restante */
            height: 100%;
        }

        /* Estilos de Botones del Men√∫ */
        .btn-filtro {
            width: 100%; padding: 10px; cursor: pointer;
            background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; text-align: left; font-size: 14px;
            transition: background 0.2s;
        }
        .btn-filtro:hover { background: #dee2e6; }
        
        .btn-ruta-final { 
            background: #28a745; color: white; font-weight: bold; 
            text-align: center; border: none; padding: 12px;
            margin-top: 10px;
        }
        .btn-ruta-final:hover { background: #218838; }

        /* --- NUEVOS ESTILOS: TARJETAS DE EVENTOS EN LA LISTA --- */
        .lista-container { margin-top: 20px; }
        
        .evento-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer; /* Manito al pasar el mouse */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .evento-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.2);
        }
        .evento-card h4 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
        .evento-card .meta { font-size: 0.85em; color: #666; margin-bottom: 8px; }
        .evento-card .descripcion-completa { font-size: 0.9em; color: #444; margin-bottom: 10px; line-height: 1.4; }
        
        /* Bot√≥n "Agendar" peque√±o */
        .btn-agendar {
            padding: 6px 12px;
            font-size: 0.85em;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        /* Estado cuando est√° seleccionado */
        .btn-agendar.agendado {
            background: #007bff;
            color: white;
        }

        /* Secci√≥n de resultados de la ruta */
        .info-ruta { 
            margin-top: 15px; font-size: 0.9em; 
            background: #e8f4ff; padding: 10px; border-radius: 5px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <h3>üé≠ Filtros</h3>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button class="btn-filtro" onclick="filtrar('Todos')">üëÅÔ∏è Ver Todo</button>
                <button class="btn-filtro" onclick="filtrar('Teatro')">üé≠ Teatro</button>
                <button class="btn-filtro" onclick="filtrar('M√∫sica')">üéµ M√∫sica</button>
                <button class="btn-filtro" onclick="filtrar('Cine')">üé¨ Cine</button>
                <button class="btn-filtro" onclick="filtrar('Arte/Expo')">üñºÔ∏è Arte / Expo</button>
            </div>
            
            <hr style="width: 100%; border-color: #ddd;">

            <h3>üìÖ Eventos Disponibles</h3>
            <div id="lista-lateral" class="lista-container">
                <p style="color:#666">Cargando eventos...</p>
            </div>

            <hr style="width: 100%; border-color: #ddd;">
            
            <button class="btn-ruta-final" onclick="crearRutaConSeleccionados()">üöÄ Crear Ruta con Mis Eventos</button>
            
            <div id="lista-ruta-resultado" class="info-ruta" style="display: none;"></div>
        </div>

        <div id="map"></div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // TUS CLAVES REALES
        const firebaseConfig = {
            apiKey: "AIzaSyCxwRwF97SheBpKd0bfZ6Gcw8XQH2QwNbc",
            authDomain: "mapacultural-lima.firebaseapp.com",
            projectId: "mapacultural-lima",
            storageBucket: "mapacultural-lima.firebasestorage.app",
            messagingSenderId: "170254428690",
            appId: "1:170254428690:web:0b7dbd02636b6af29446cb"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Iniciar Mapa
        const map = L.map('map').setView([-12.046, -77.042], 13); // Un poco m√°s de zoom inicial
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Variables globales
        let todosLosEventos = []; // Todos los descargados
        let eventosFiltrados = []; // Los que se ven actualmente seg√∫n el filtro
        let seleccionadosIDs = new Set(); // MEMORIA: Guarda los IDs de los eventos que el usuario quiere agendar
        let marcadores = {}; // Diccionario para buscar marcadores por ID r√°pido
        let lineaRuta = null;

        // 1. Descargar eventos y asignarles un ID √∫nico
        db.collection("eventos").get().then((snapshot) => {
            snapshot.forEach((doc) => {
                let data = doc.data();
                data.id = doc.id; // Usamos el ID del documento de Firestore
                todosLosEventos.push(data);
            });
            // Al inicio mostramos todos
            eventosFiltrados = todosLosEventos;
            actualizarVista(eventosFiltrados);
        });

        // --- FUNCI√ìN PRINCIPAL QUE ACTUALIZA MAPA Y LISTA LATERAL ---
        function actualizarVista(listaDeEventos) {
            // A) Limpiar mapa
            for (let id in marcadores) map.removeLayer(marcadores[id]);
            marcadores = {};
            if(lineaRuta) map.removeLayer(lineaRuta);
            document.getElementById('lista-ruta-resultado').style.display = 'none';

            // B) Generar HTML para la lista lateral
            let htmlLista = "";
            if (listaDeEventos.length === 0) htmlLista = "<p>No se encontraron eventos.</p>";

            listaDeEventos.forEach(ev => {
                // Validaci√≥n de coordenadas
                let lat = parseFloat(ev.lat);
                let lon = parseFloat(ev.lon);
                if(isNaN(lat) || isNaN(lon)) return;

                // 1. Crear marcador en el mapa
                let marker = L.marker([lat, lon])
                    .bindPopup(`<b>${ev.hora}</b><br>${ev.nombre}<br><i>${ev.lugar}</i>`);
                marker.addTo(map);
                marcadores[ev.id] = marker; // Guardamos referencia

                // 2. Crear tarjeta en la lista lateral
                // Verificamos si ya estaba seleccionado
                const estaAgendado = seleccionadosIDs.has(ev.id);
                const claseBoton = estaAgendado ? 'btn-agendar agendado' : 'btn-agendar';
                const textoBoton = estaAgendado ? '‚úÖ Agendado' : 'Agendar';

                htmlLista += `
                    <div class="evento-card" onclick="resaltarEnMapa('${ev.id}')">
                        <h4>${ev.nombre}</h4>
                        <div class="meta">üïí ${ev.hora} | üìÖ ${ev.dia || ''} <br> üìç ${ev.lugar}</div>
                        <div class="descripcion-completa">${ev.nombre_completo}</div>
                        <button id="btn-${ev.id}" class="${claseBoton}" onclick="event.stopPropagation(); toggleAgendar('${ev.id}')">
                            ${textoBoton}
                        </button>
                    </div>
                `;
            });

            // C) Insertar el HTML en la barra lateral
            document.getElementById('lista-lateral').innerHTML = htmlLista;
        }

        // --- FUNCIONES DE INTERACCI√ìN ---

        // Filtros
        function filtrar(tipo) {
            if(tipo === 'Todos') {
                eventosFiltrados = todosLosEventos;
            } else {
                eventosFiltrados = todosLosEventos.filter(e => e.tipo === tipo);
            }
            actualizarVista(eventosFiltrados);
        }

        // Al hacer clic en la tarjeta lateral, el mapa viaja al marcador
        function resaltarEnMapa(id) {
            const marker = marcadores[id];
            if (marker) {
                map.flyTo(marker.getLatLng(), 16, { duration: 1.5 }); // Zoom suave
                marker.openPopup();
            }
        }

        // Funci√≥n del bot√≥n "Agendar" / "Desagendar"
        function toggleAgendar(id) {
            const btn = document.getElementById(`btn-${id}`);
            
            if (seleccionadosIDs.has(id)) {
                // Si ya estaba, lo quitamos
                seleccionadosIDs.delete(id);
                btn.classList.remove('agendado');
                btn.innerHTML = 'Agendar';
            } else {
                // Si no estaba, lo agregamos
                seleccionadosIDs.add(id);
                btn.classList.add('agendado');
                btn.innerHTML = '‚úÖ Agendado';
            }
            // Ocultamos resultado de ruta anterior si cambia la selecci√≥n
            document.getElementById('lista-ruta-resultado').style.display = 'none';
             if(lineaRuta) map.removeLayer(lineaRuta);
        }

        // --- ALGORITMO DE RUTA FINAL ---
        function crearRutaConSeleccionados() {
            // 1. Filtramos solo los eventos cuyos IDs est√°n en el Set de seleccionados
            let rutaEventos = todosLosEventos.filter(ev => seleccionadosIDs.has(ev.id));

            if (rutaEventos.length < 2) {
                alert("Por favor, agenda al menos 2 eventos para crear una ruta.");
                return;
            }

            // 2. Ordenar por hora (Lo m√°s robusto por ahora)
            // Nota sobre cercan√≠a: Ordenar por tiempo Y cercan√≠a a la vez es un problema matem√°tico complejo.
            // Para esta versi√≥n, el orden cronol√≥gico es el m√°s sensato para una agenda cultural.
            rutaEventos.sort((a, b) => a.hora.localeCompare(b.hora));
            
            // 3. Dibujar l√≠nea
            let latlngs = rutaEventos.map(e => [parseFloat(e.lat), parseFloat(e.lon)]);
            
            if(lineaRuta) map.removeLayer(lineaRuta);
            // L√≠nea azul m√°s gruesa para que resalte
            lineaRuta = L.polyline(latlngs, {color: '#007bff', weight: 5, opacity: 0.8}).addTo(map);
            map.fitBounds(lineaRuta.getBounds(), {padding: [50, 50]}); // Enfocar la ruta con margen

            // 4. Mostrar el itinerario final textual en la barra lateral
            let html = "<b>üóìÔ∏è Tu Itinerario Cultural:</b><br><br>";
            rutaEventos.forEach((e, i) => {
                html += `
                    <div style="margin-bottom:10px; padding-bottom:5px; border-bottom:1px dotted #ccc;">
                        <b>${i+1}. [${e.hora}]</b> ${e.nombre}<br>
                        <small>üìç ${e.lugar}</small>
                    </div>`;
            });
            const resultadoDiv = document.getElementById('lista-ruta-resultado');
            resultadoDiv.innerHTML = html;
            resultadoDiv.style.display = 'block';
            // Hacer scroll autom√°tico hacia el resultado
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
