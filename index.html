<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cultural de Lima</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ESTILOS: Aseguran que la p√°gina ocupe el 100% de la pantalla */
        body, html { margin: 0; padding: 0; font-family: sans-serif; height: 100%; overflow: hidden; }
        
        .main-container {
            display: flex;
            height: 100vh; /* Altura completa */
            width: 100%;
        }

        /* BARRA LATERAL */
        .sidebar {
            width: 350px;
            min-width: 300px;
            background: #f8f9fa;
            padding: 15px;
            overflow-y: auto; /* Scroll si la lista es larga */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1001; /* Asegura que est√© sobre el mapa */
        }

        /* EL MAPA */
        #map { 
            flex-grow: 1; 
            height: 100%; 
            background: #e0e0e0; /* Fondo gris mientras carga */
        }

        /* T√≠tulos y Botones */
        .titulo-seccion { font-size: 1.1em; margin-bottom: 5px; color: #333; font-weight: bold; }

        .btn-filtro {
            width: 100%; padding: 10px; cursor: pointer;
            background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; text-align: left; font-size: 14px;
            transition: background 0.2s; margin-bottom: 5px;
        }
        .btn-filtro:hover { background: #dee2e6; }
        .btn-filtro.activo { background: #007bff; color: white; border-color: #0056b3; }

        /* Men√∫ desplegable de D√≠as */
        select.filtro-dia {
            width: 100%; padding: 10px; background: #fff; border: 2px solid #007bff;
            border-radius: 4px; font-size: 15px; color: #333; cursor: pointer; margin-bottom: 15px; font-weight: bold;
        }

        /* Bot√≥n Ruta */
        .btn-ruta-final { 
            background: #28a745; color: white; font-weight: bold; 
            text-align: center; border: none; padding: 12px;
            margin-top: 10px; cursor: pointer; width: 100%; border-radius: 4px;
        }
        .btn-ruta-final:hover { background: #218838; }

        /* Tarjetas de Eventos */
        .lista-container { margin-top: 10px; }
        .evento-card {
            background: white; border: 1px solid #ddd; border-radius: 6px;
            padding: 12px; margin-bottom: 10px; cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .evento-card:hover { border-color: #007bff; box-shadow: 0 2px 8px rgba(0,123,255,0.2); }
        .evento-card h4 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
        .evento-card .meta { font-size: 0.85em; color: #666; margin-bottom: 8px; }
        
        .btn-agendar {
            padding: 6px 12px; font-size: 0.85em; border: 1px solid #007bff;
            background: white; color: #007bff; border-radius: 20px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-agendar.agendado { background: #007bff; color: white; }

        .info-ruta { 
            margin-top: 15px; font-size: 0.9em; background: #e8f4ff; 
            padding: 10px; border-radius: 5px; border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <div class="titulo-seccion">üìÖ ¬øCu√°ndo quieres salir?</div>
            <select id="select-dias" class="filtro-dia" onchange="cambiarFiltroDia()">
                <option value="Todos">Ver Todos los D√≠as</option>
            </select>

            <hr style="width: 100%; border-color: #ddd;">

            <div class="titulo-seccion">üé≠ ¬øQu√© quieres ver?</div>
            <div id="botones-categorias">
                <button class="btn-filtro activo" onclick="cambiarFiltroCategoria('Todos', this)">üëÅÔ∏è Ver Todo</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Teatro', this)">üé≠ Teatro</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('M√∫sica', this)">üéµ M√∫sica</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Cine', this)">üé¨ Cine</button>
                <button class="btn-filtro" onclick="cambiarFiltroCategoria('Arte/Expo', this)">üñºÔ∏è Arte / Expo</button>
            </div>
            
            <hr style="width: 100%; border-color: #ddd;">

            <div class="titulo-seccion">Resultados: <span id="contador-eventos">0</span></div>
            <div id="lista-lateral" class="lista-container">
                <p style="color:#666">Cargando eventos...</p>
            </div>

            <hr style="width: 100%; border-color: #ddd;">
            <button class="btn-ruta-final" onclick="crearRutaConSeleccionados()">üöÄ Crear Ruta con Mis Eventos</button>
            <div id="lista-ruta-resultado" class="info-ruta" style="display: none;"></div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- BLOQUE DE SEGURIDAD PARA DETECTAR ERRORES ---
        try {
            // 1. CONFIGURACI√ìN FIREBASE
            const firebaseConfig = {
                apiKey: "AIzaSyCxwRwF97SheBpKd0bfZ6Gcw8XQH2QwNbc",
                authDomain: "mapacultural-lima.firebaseapp.com",
                projectId: "mapacultural-lima",
                storageBucket: "mapacultural-lima.firebasestorage.app",
                messagingSenderId: "170254428690",
                appId: "1:170254428690:web:0b7dbd02636b6af29446cb"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // 2. INICIAR MAPA
            const map = L.map('map').setView([-12.046, -77.042], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // VARIABLES GLOBALES
            let todosLosEventos = [];
            let seleccionadosIDs = new Set();
            let marcadores = {}; 
            let lineaRuta = null;
            let filtroDiaActual = 'Todos';
            let filtroCategoriaActual = 'Todos';

            // 3. DESCARGAR DATOS DE LA NUBE
            console.log("Iniciando descarga de Firebase...");
            db.collection("eventos").get().then((snapshot) => {
                if (snapshot.empty) {
                    document.getElementById('lista-lateral').innerHTML = "<p>La base de datos est√° vac√≠a. Ejecuta el scraper en Python.</p>";
                    return;
                }

                snapshot.forEach((doc) => {
                    let data = doc.data();
                    data.id = doc.id;
                    todosLosEventos.push(data);
                });
                
                console.log(`Se descargaron ${todosLosEventos.length} eventos.`);
                
                // Configurar filtros
                llenarDropdownDias();
                aplicarFiltrosCombinados();

            }).catch((error) => {
                console.error("Error Firebase:", error);
                alert("Error conectando a la base de datos: " + error.message);
                document.getElementById('lista-lateral').innerHTML = "<p style='color:red'>Error de conexi√≥n.</p>";
            });

            // --- FUNCIONES ---

            function llenarDropdownDias() {
                const select = document.getElementById('select-dias');
                const diasUnicos = new Set();
                todosLosEventos.forEach(ev => { if(ev.dia) diasUnicos.add(ev.dia); });
                const listaDias = Array.from(diasUnicos).sort();
                
                // Limpiar opciones previas (excepto la primera)
                select.innerHTML = '<option value="Todos">Ver Todos los D√≠as</option>';

                listaDias.forEach(dia => {
                    let option = document.createElement("option");
                    option.value = dia;
                    option.text = "üìÖ " + dia;
                    select.appendChild(option);
                });
            }

            function cambiarFiltroDia() {
                filtroDiaActual = document.getElementById('select-dias').value;
                aplicarFiltrosCombinados();
            }

            function cambiarFiltroCategoria(categoria, botonPresionado) {
                filtroCategoriaActual = categoria;
                const botones = document.querySelectorAll('#botones-categorias .btn-filtro');
                botones.forEach(btn => btn.classList.remove('activo'));
                botonPresionado.classList.add('activo');
                aplicarFiltrosCombinados();
            }

            function aplicarFiltrosCombinados() {
                const eventosFiltrados = todosLosEventos.filter(ev => {
                    const coincideDia = (filtroDiaActual === 'Todos') || (ev.dia === filtroDiaActual);
                    const coincideCat = (filtroCategoriaActual === 'Todos') || (ev.tipo === filtroCategoriaActual);
                    return coincideDia && coincideCat;
                });
                actualizarVista(eventosFiltrados);
            }

            function actualizarVista(listaDeEventos) {
                // Limpiar mapa
                for (let id in marcadores) map.removeLayer(marcadores[id]);
                marcadores = {};
                if(lineaRuta) map.removeLayer(lineaRuta);
                document.getElementById('lista-ruta-resultado').style.display = 'none';

                let htmlLista = "";
                document.getElementById('contador-eventos').innerText = listaDeEventos.length;

                if (listaDeEventos.length === 0) {
                    htmlLista = "<p style='text-align:center; padding:20px; color:#777;'>No se encontraron eventos con estos filtros.</p>";
                }

                listaDeEventos.forEach(ev => {
                    let lat = parseFloat(ev.lat);
                    let lon = parseFloat(ev.lon);
                    if(isNaN(lat) || isNaN(lon)) return;

                    // Marcador
                    let marker = L.marker([lat, lon])
                        .bindPopup(`<b>${ev.hora}</b><br>${ev.nombre}<br><i>${ev.lugar}</i>`);
                    marker.addTo(map);
                    marcadores[ev.id] = marker;

                    // Tarjeta
                    const estaAgendado = seleccionadosIDs.has(ev.id);
                    const claseBoton = estaAgendado ? 'btn-agendar agendado' : 'btn-agendar';
                    const textoBoton = estaAgendado ? '‚úÖ Agendado' : 'Agendar';

                    htmlLista += `
                        <div class="evento-card" onclick="resaltarEnMapa('${ev.id}')">
                            <h4>${ev.nombre}</h4>
                            <div class="meta">üïí ${ev.hora} | ${ev.dia || ''} <br> üìç ${ev.lugar}</div>
                            <button id="btn-${ev.id}" class="${claseBoton}" onclick="event.stopPropagation(); toggleAgendar('${ev.id}')">
                                ${textoBoton}
                            </button>
                        </div>
                    `;
                });

                document.getElementById('lista-lateral').innerHTML = htmlLista;
            }

            function resaltarEnMapa(id) {
                const marker = marcadores[id];
                if (marker) {
                    map.flyTo(marker.getLatLng(), 16, { duration: 1.5 });
                    marker.openPopup();
                }
            }

            window.toggleAgendar = function(id) {
                const btn = document.getElementById(`btn-${id}`);
                if (seleccionadosIDs.has(id)) {
                    seleccionadosIDs.delete(id);
                    btn.classList.remove('agendado');
                    btn.innerHTML = 'Agendar';
                } else {
                    seleccionadosIDs.add(id);
                    btn.classList.add('agendado');
                    btn.innerHTML = '‚úÖ Agendado';
                }
                document.getElementById('lista-ruta-resultado').style.display = 'none';
                if(lineaRuta) map.removeLayer(lineaRuta);
            }

            window.crearRutaConSeleccionados = function() {
                let rutaEventos = todosLosEventos.filter(ev => seleccionadosIDs.has(ev.id));
                if (rutaEventos.length < 2) {
                    alert("Selecciona al menos 2 eventos para crear una ruta.");
                    return;
                }
                rutaEventos.sort((a, b) => a.hora.localeCompare(b.hora));
                
                let latlngs = rutaEventos.map(e => [parseFloat(e.lat), parseFloat(e.lon)]);
                if(lineaRuta) map.removeLayer(lineaRuta);
                lineaRuta = L.polyline(latlngs, {color: '#007bff', weight: 5, opacity: 0.8}).addTo(map);
                map.fitBounds(lineaRuta.getBounds(), {padding: [50, 50]});

                let html = "<b>üóìÔ∏è Tu Itinerario:</b><br><br>";
                rutaEventos.forEach((e, i) => {
                    html += `<div style="margin-bottom:10px; border-bottom:1px dotted #ccc;">
                                <b>${i+1}. [${e.hora}]</b> ${e.nombre}<br><small>üìç ${e.lugar}</small>
                             </div>`;
                });
                const resDiv = document.getElementById('lista-ruta-resultado');
                resDiv.innerHTML = html;
                resDiv.style.display = 'block';
                resDiv.scrollIntoView({ behavior: 'smooth' });
            }

        } catch (errorCr√≠tico) {
            alert("‚ö†Ô∏è Error Cr√≠tico en el c√≥digo: " + errorCr√≠tico.message);
            console.error(errorCr√≠tico);
        }
    </script>
</body>
</html>
